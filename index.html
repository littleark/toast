<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>toast</title>
	<link rel="stylesheet" href="css/toast.css">
	<script type="text/javascript" src="js/vendors/dat.gui.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js" charset="utf-8"></script>
	<script>window.d3||document.write('<script src="js/vendors/d3/d3.min.js"><\/script>');</script>
</head>
<body>
	<div id="toast"></div>
	<script>

		var data={
				table:{
					x:0,
					y:0.76,
					w:0.6,
					h:0.03
				},
				physics:{
					g:9.81
				},
				toast: {
					l:0.11,
					h:0.02,
					us:0.2
				},
				positions:[],
				end:{

				}
			};

		function calculateTimeAngle(h) {

			var h=(typeof h!='undefined')?h:data.table.y;

			var tgTheta=data.toast.us/(1+36*(data.toast.h*data.toast.h/(data.toast.l*data.toast.l))),
				atanTheta=Math.atan(tgTheta),
				dThetadt=Math.sqrt(2*data.physics.g*atanTheta/(data.toast.h*(1+data.toast.l*data.toast.l/(12*data.toast.h*data.toast.h)))),
				dT=Math.sqrt(2*h/data.physics.g),
				thetaRad=dThetadt*dT,
				thetaDeg=thetaRad*180/Math.PI;

			return {
				dT:dT,
				thetaRad:thetaRad,
				thetaDeg:thetaDeg
			}

		};

		data.end=calculateTimeAngle();

		console.log(data)

		function calculateAllPositions() {
			data.positions=[];
			for(var t=0;t<data.end.dT;t+=0.01) {
				var y=1/2*data.physics.g*(t*t);
				//console.log(y)
				var current=calculateTimeAngle(y);
				//console.log(t,data.table.y-y,current.thetaDeg)

				data.positions.push({
					t:t,
					y:data.table.y-y,
					rad:current.thetaRad,
					deg:current.thetaDeg,
					p:data.positions.length
				})

			}

			data.positions.push({
				t:data.end.dT,
				y:0,
				rad:data.end.thetaRad,
				deg:data.end.thetaDeg,
				p:data.positions.length
			})
		}
		calculateAllPositions();

		var WIDTH=500,
			HEIGHT=500;

		var margins={
			top:20,
			bottom:20,
			left:30,
			right:30
		}

		var svg=d3.select("#toast")
					.append("svg")
					.attr("width",WIDTH)
					.attr("height",HEIGHT);

		var xscale=d3.scale.linear().domain([0,1]).range([0,WIDTH-(margins.left+margins.right)]),
			yscale=d3.scale.linear().domain([0,1]).range([HEIGHT-(margins.top+margins.bottom),0]);

		
		
		var world=svg.append("g")
						.attr("id","world")
						.attr("transform","translate("+margins.left+","+margins.top+")")

		var table=world.append("g")
					.attr("id","table")
					.attr("transform",function(){

						var x=xscale(data.table.x),
							y=yscale(data.table.y);

						return "translate("+x+","+y+")";
					});
		table.append("rect")
				.attr("x",0)
				.attr("y",0)
				.attr("width",xscale(data.table.w))
				.attr("height",xscale(data.table.h));

		table.append("line")
				.attr("class","dropline")
				.attr("x1",xscale(data.table.x)+xscale(data.table.w))
				.attr("y1",0)
				.attr("x2",xscale.range()[1])
				.attr("y2",0)


		var floor=world.append("g")
					.attr("id","floor")
					.attr("transform","translate(0,"+yscale.range()[0]+")")
					.append("rect")
						.attr("x",0)
						.attr("y",0)
						.attr("width",xscale.range()[1])
						.attr("height",3)


		var toast=world.append("g")
					.attr("id","toast");

		data.toasts=[];



		update();

		//AXIS

		var xAxis = d3.svg.axis().scale(xscale);
		var yAxis = d3.svg.axis().scale(yscale).orient("right");

		var axes=svg.append("g")
						.attr("id","axes")
						.attr("transform","translate("+margins.left+","+margins.top+")")

		axes.append("g")
	      .attr("class", "x axis")
	      .attr("transform", "translate(0,0)")
	      .call(xAxis)

	   	axes.append("g")
	      .attr("class", "y axis")
	      .attr("transform", "translate("+(WIDTH-(margins.left+margins.right))+",0)")
	      .call(yAxis)

	    function update() {
	    	data.end=calculateTimeAngle();
	    	calculateAllPositions();

	    	var toasts=toast.selectAll("g.toast")
						.data(data.positions,function(d,i){
							return "p"+d.p;
						});

			var new_toasts=toasts
								.enter()
								.append("g")
									.attr("class","toast")
									.attr("rel",function(d){
										console.log("rel",d.p)
										return d.p+": "+d.y+","+d.deg;
									})
							

			toasts.exit().remove();

			new_toasts.append("rect")
					.attr("x",-xscale(data.toast.l/2))
					.attr("y",-xscale(0.01/2))
					.attr("width",xscale(data.toast.l))
					.attr("height",xscale(0.01))

			new_toasts.append("line")
					.attr("class","butter")
					.attr("x1",-xscale(data.toast.l/2))
					.attr("y1",-xscale(0.01/2))
					.attr("x2",xscale(data.toast.l/2))
					.attr("y2",-xscale(0.01/2))

			new_toasts.append("circle")
					.attr("cx",0)
					.attr("cy",0)
					.attr("r",1)

			toasts
				.attr("transform",function(d,i){
					var x=xscale(data.table.w+data.toast.h),//+0.3*i,
						y=yscale(d.y)
					return "translate("+x+","+y+")rotate("+d.deg+")"
				});

			table
				.attr("transform",function(){

					var x=xscale(data.table.x),
						y=yscale(data.table.y);

					return "translate("+x+","+y+")";
				});

	    }

	    var gui = new dat.GUI();
		//gui.add(text, 'message');
		//gui.add(text, 'speed', -5, 5);
		//gui.add(text, 'displayOutline');
		//gui.add(text, 'explode');
		var controllers={
			tableH:gui.add(data.table, "y", 0.1,0.9),
			overhang:gui.add(data.toast, "h", 0.01,0.05).step(0.01)
		}
		controllers["tableH"].onChange(function(value) {
		  // Fires on every change, drag, keypress, etc.
		});

		controllers["tableH"].onFinishChange(function(value) {
		  // Fires when a controller loses focus.
		  update();
		});

		controllers["overhang"].onFinishChange(function(value) {
		  // Fires when a controller loses focus.
		  update();
		});

	</script>
</body>
</html>